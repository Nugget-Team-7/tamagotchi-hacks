# "Why the Uni is so secure"
The Uni is built on a very modern microcontroller called and ESP32-S3 (specifically the 16MB (believed) version of the ESP32-S3-WROOM-1U)
The ESP32-S3 has some very sophisticated and modern security features, and it appears that they are all enabled to defaults.

## Flash Encryption
On most Tamagotchis, we can clip a test clip onto the 8pin flash chip (generally a 25XX series) and get a flash dump using a CH341A or T48 programmer, and get all the code, bootloader, etc.

The ESP32-S3 first has an RF (radio frequency) shield over the microcontroller which first has to be removed. Its easy enough, just put on a reflow plate (hot plate type thing with precise temperature control) to melt all the solder on the board and then remove it.

Following that, there is actually a standard 25XX flash chip that we _can_ dump the code off of, but..

**Problem:** flash encryption. The ESP32-S3 has hardware security devices including an XAES encryption module. The flash is encrypted with the XAES module using either a 128-bit or 256-bit key length (the actual key is actually double, so 256-bit or 512-bit respectively for technical reasons, but the actual AES encryption is only 128-bit or 256-bit). It is unknown what key length the Uni uses, but both are functionally unbreakable by brute force.

The key is stored in a read-only register (tiny bit of storage bound to the CPU) and even then is only accessible by the "secure world" (privileged) part of the CPU, so there is no way to directly get it without a mega exploit.

If they are using the default security features of the ESP32-S3 via the esp-idf SDK (software kit), then each Uni has its own, unique key that is generated on-chip at install time at the factory. The key would be generated by an onboard, secure TRNG (True Random Number Generator) that is audited to produce cryptographically secure random numbers, so a cryptographic key bias attack is functionally off the table.

## HTTPS, TLS, and Certificate Pinning
The Uni communicates with the Tamaverse and update servers via HTTPS utilizing the TLS1.2 protocol, a very secure, modern protocol.
Because its using secure HTTPS, Man in the Middle (MitM) attacks are also functionally off the table.

We also can not _pretend_ to be an Uni.  The Uni contains a private-public key pair that it uses to authenticate with the server. Without the key pair, we can not spoof a connection and try to read it that way. It is probable that there is one single client-side key pair that is used on all Unis, or that there is one for each region.

The key pair is likewise stored in a secure CPU register and that's 100% gonna be a problem.

## Secure Over-The-Air Signed Updates
The ESP32-S3 supports over-the-air (OTA) updates (meaning downloading from the internet, but each of the updates must be signed by Bandai's production key pair. They have a private-public key pair that is probable to be the same for all Unis or at least regionally.
The Uni will not contain Bandai's production private key, instead it will have Bandai's public key that it will use to authenticate the signature on the update.

## What We Have In Our Favor
First, we know the ESP32-S3 very well. its a very well understood, mostly open source microcontroller that has a ton of eyes on it, and its near certain new attacks will come out against it over time.
Time is on our side.

Second, we know a ton of the libraries and software Bandai uses on the Uni because of the Uni legal page: [Live Page](https://tamagotchi-official.com/legalinfo/toy/uni/) - [Archive.org](https://web.archive.org/web/20240717022018/https://tamagotchi-official.com/legalinfo/toy/uni/) - [Archive.is](https://archive.is/yZinj)
Because those are open source software, we can continue to scrub the github pages for security vulnerabilities to exploit ( :crocwalk~2: )

We actually know a fair amount about their [network infrastructure](https://aws.amazon.com/blogs/iot/efficiently-managing-millions-of-tamagotchi-devices-with-aws-iot/) both from that blog entry, social media posts on Linkedin, and from knowing the domain names, IP addresses, and other public info about the servers the Uni connects to by simple wifi sniffing.

## Our Plan of Attack
First order of business: decrypt that damn flash.
This will yield us an asset dump, and a ton of more information on the internals.

At current we are attempting a Dynamic Power Analysis (DPA) attack. The general idea is that the ESP32-S3 will use very slightly more power when processing a 1 (on) than a 0 (off), so booting and rebooting over and over, say 100,000 times, while carefully monitoring power usage with an oscilloscope can give us a dump of data that can statistically analyze to hopefully find the key to the specific Uni attacked.

Once we get a key and a flash dump, we'll be in a very strong position so we can begin actively hunting for a real exploit to finally, finally, finally hack the nugget!

## Resources
https://raelize.com/blog/espressif-systems-esp32-breaking-hw-aes-with-power-analysis/
https://electronupdate.blogspot.com/2018/08/espressif-esp32-teardown.html
https://aws.amazon.com/blogs/iot/efficiently-managing-millions-of-tamagotchi-devices-with-aws-iot/
https://olof-astrand.medium.com/reverse-engineering-of-esp32-flash-dumps-with-ghidra-or-ida-pro-8c7c58871e68
https://courk.cc/breaking-flash-encryption-of-espressif-parts
https://courk.cc/esp32-c3-c6-fault-injection
https://tamagotchi-official.com/legalinfo/toy/uni/
